{% extends 'layouts/adminlte_base.html' %}
{% block extra_css %}
<style>
  /* Modern Card Style for Occupied Events */
  .fc-event-occupied {
    background-color: #fee2e2 !important; /* Soft Pastel Red */
    border: none !important;
    border-left: 4px solid #ef4444 !important; /* Accent Red */
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
    transition: all 0.2s ease;
  }
  
  .fc-event-occupied:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.12) !important;
    transform: translateY(-1px);
  }

  .fc-event-occupied .fc-event-main {
    color: #7f1d1d !important; /* Dark Red Text */
    padding: 4px 8px !important;
    font-family: 'Source Sans Pro', sans-serif;
  }

  .fc-custom-content {
    display: flex;
    align-items: center;
    font-weight: 600;
    font-size: 0.95rem;
    height: 100%;
  }

  .fc-custom-content i {
    margin-right: 6px;
    font-size: 0.85rem;
    opacity: 0.7;
  }

  /* Hover effects for cards */
  .hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
  }
</style>
{% endblock %}
{% set title = 'Consultar disponibilidad' %}
{% block page_header %}
<div class="row mb-2">
  <div class="col-sm-6"><h1 class="m-0">Disponibilidad</h1></div>
  <div class="col-sm-6"><ol class="breadcrumb float-sm-right"><li class="breadcrumb-item"><a href="{{ url_for('reservas.index') }}">Mis reservas</a></li><li class="breadcrumb-item active">Disponibilidad</li></ol></div>
</div>
{% endblock %}
{% block content %}

<!-- Hidden Form for Submission -->
<form id="availabilityForm" method="post" style="display:none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="recurso_id" id="inputRecursoId">
    <input type="hidden" name="zona" id="inputZonaId">
    <input type="hidden" name="fecha" value="{{ fecha_actual or '' }}">
</form>

{% if not data %}
    <!-- Step 1: Zone Selection -->
    <div id="step-zones" class="container-fluid fade-in">
        <h3 class="text-center mb-4 text-muted">Selecciona una Zona</h3>
        <div class="row justify-content-center">
            {% for z in zonas %}
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100 shadow-sm hover-card" onclick="selectZone('{{ z.id }}', '{{ z.nombre }}')" style="cursor:pointer; transition: all 0.3s ease; border-radius: 15px; overflow: hidden;">
                    <div style="height: 200px; overflow: hidden;">
                        <img src="{{ z.imagen_url or 'https://via.placeholder.com/400x250?text=' + z.nombre }}" class="card-img-top" alt="{{ z.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="card-body text-center">
                        <h4 class="card-title font-weight-bold">{{ z.nombre }}</h4>
                        <p class="card-text text-muted mt-2">{{ z.descripcion or 'Espacio disponible' }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Step 2: Resource Selection -->
    <div id="step-resources" class="container-fluid fade-in" style="display:none;">
        <div class="d-flex align-items-center mb-4">
            <button class="btn btn-outline-secondary mr-3 rounded-circle" onclick="showZones()" style="width: 40px; height: 40px;"><i class="fas fa-arrow-left"></i></button>
            <h3 class="m-0 text-muted">Recursos en <span id="selectedZoneName" class="text-dark font-weight-bold"></span></h3>
        </div>
        <div class="row" id="resourcesContainer">
            {% for r in recursos %}
            <div class="col-md-3 col-sm-6 mb-4 resource-card-wrapper" data-zona-id="{{ r.zona_id }}" style="display:none;">
                <div class="card h-100 shadow-sm hover-card" onclick="selectResource('{{ r.id }}')" style="cursor:pointer; transition: all 0.3s ease; border-radius: 12px; overflow: hidden;">
                    <div style="height: 160px; overflow: hidden;">
                        <img src="{{ r.imagen_url or 'https://via.placeholder.com/300x200?text=' + r.nombre }}" class="card-img-top" alt="{{ r.nombre }}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div class="card-body text-center p-3">
                        <h5 class="card-title font-weight-bold mb-1" style="font-size: 1.1rem;">{{ r.nombre }}</h5>
                        <span class="badge badge-light">{{ r.tipo }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div id="noResourcesMsg" class="text-center text-muted mt-5" style="display:none;">
            <h4>No hay recursos disponibles en esta zona.</h4>
        </div>
    </div>

{% else %}
    <!-- Step 3: Calendar View -->
    <div class="mb-3">
        <a href="{{ url_for('reservas.disponibilidad') }}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left mr-1"></i> Seleccionar otro recurso</a>
    </div>

    {% set mant_activo = (data.recurso.estado in ['EN_MANTENIMIENTO','FUERA_DE_SERVICIO']) and (data.recurso.mantenimiento_inicio and data.recurso.mantenimiento_fin and data.recurso.mantenimiento_inicio <= now_iso and data.recurso.mantenimiento_fin > now_iso) %}
    {% if mant_activo or (data.recurso.estado in ['EN_MANTENIMIENTO','FUERA_DE_SERVICIO'] and not data.recurso.mantenimiento_inicio) %}
        <div class="alert alert-warning">El recurso está en {{ data.recurso.estado.replace('_',' ').lower() }}. No se pueden crear reservas.</div>
    {% else %}
        <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
            <div class="d-flex justify-content-between align-items-center">
            <div>
                <form method="post" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="recurso_id" value="{{ data.recurso.id }}" />
                <input type="hidden" name="fecha" value="{{ fecha_actual }}" />
                <input type="hidden" name="zona_hidden" value="{{ zona_sel or '' }}" />
                <input type="hidden" name="nav" value="prev" />
                <button class="btn btn-outline-secondary btn-sm rounded-circle" title="Día anterior" {% if fecha_actual <= hoy_str %}disabled{% endif %} style="width: 32px; height: 32px;"><i class="fas fa-chevron-left"></i></button>
                </form>
                <span class="mx-3 h4 align-middle">{{ fecha_actual }}</span>
                <form method="post" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="recurso_id" value="{{ data.recurso.id }}" />
                <input type="hidden" name="fecha" value="{{ fecha_actual }}" />
                <input type="hidden" name="zona_hidden" value="{{ zona_sel or '' }}" />
                <input type="hidden" name="nav" value="today" />
                <button class="btn btn-outline-primary btn-sm mx-1" title="Ir a hoy">Hoy</button>
                </form>
                <form method="post" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <input type="hidden" name="recurso_id" value="{{ data.recurso.id }}" />
                <input type="hidden" name="fecha" value="{{ fecha_actual }}" />
                <input type="hidden" name="zona_hidden" value="{{ zona_sel or '' }}" />
                <input type="hidden" name="nav" value="next" />
                <button class="btn btn-outline-secondary btn-sm rounded-circle" title="Día siguiente" {% if fecha_actual >= max_fecha_str %}disabled{% endif %} style="width: 32px; height: 32px;"><i class="fas fa-chevron-right"></i></button>
                </form>
            </div>
            <div class="text-right">
                <h3 class="card-title float-none font-weight-bold text-primary">{{ data.recurso.nombre }}</h3>
                <p class="text-muted mb-0 small">{{ data.recurso.ubicacion }}</p>
            </div>
            </div>
        </div>
        <div class="card-body">
            <div id="calendar" data-fecha="{{ fecha_actual }}" data-reservas='{{ (data.reservas or [])|tojson }}' data-dur-min="{{ dur_min }}" data-dur-max="{{ dur_max }}" data-hora-ini="{{ hora_ini_ui }}" data-hora-fin="{{ hora_fin_ui }}"></div>
            <form id="crearForm" method="post" action="{{ url_for('reservas.crear') }}" class="mt-3 d-none">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <input type="hidden" name="recurso_id" value="{{ data.recurso.id }}" />
            <input type="hidden" name="fecha" value="{{ fecha_actual }}" />
            <input type="hidden" name="hora_inicio" id="horaInicio" value="{{ form_data.hora_inicio if form_data else '' }}" />
            <input type="hidden" name="hora_fin" id="horaFin" value="{{ form_data.hora_fin if form_data else '' }}" />
            <div class="alert alert-info py-2" id="seleccionInfo"></div>
            
            <!-- Sección de acompañantes (opcional) -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-users mr-1"></i> Acompañantes (opcional)</label>
                <small class="form-text text-muted d-block mb-2">Busca y agrega usuarios que te acompañarán en esta reserva</small>
                
                <div class="input-group mb-2">
                <input type="text" class="form-control" id="buscarUsuario" placeholder="Escribe el nombre del usuario...">
                <button class="btn btn-outline-secondary" type="button" id="btnBuscarUsuario">
                    <i class="fas fa-search"></i> Buscar
                </button>
                </div>
                
                <div id="resultadosBusqueda" class="list-group mb-2" style="display: none; max-height: 200px; overflow-y: auto;"></div>
                
                <div id="acompanantesSeleccionados">
                <small class="text-muted">Acompañantes agregados:</small>
                <div id="listaAcompanantes" class="mt-1"></div>
                </div>
            </div>
            
            <button class="btn btn-success"><i class="fas fa-check mr-1"></i> Confirmar reserva</button>
            </form>
        </div>
        </div>
    {% endif %}
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Navigation Logic
    function selectZone(zonaId, zonaNombre) {
        document.getElementById('step-zones').style.display = 'none';
        document.getElementById('step-resources').style.display = 'block';
        document.getElementById('selectedZoneName').innerText = zonaNombre;
        document.getElementById('inputZonaId').value = zonaId;

        // Filter resources
        let resources = document.querySelectorAll('.resource-card-wrapper');
        let count = 0;
        resources.forEach(el => {
            if (el.getAttribute('data-zona-id') == zonaId) {
                el.style.display = 'block';
                count++;
            } else {
                el.style.display = 'none';
            }
        });

        if (count === 0) {
            document.getElementById('noResourcesMsg').style.display = 'block';
        } else {
            document.getElementById('noResourcesMsg').style.display = 'none';
        }
    }

    function showZones() {
        document.getElementById('step-resources').style.display = 'none';
        document.getElementById('step-zones').style.display = 'block';
    }

    function selectResource(recursoId) {
        document.getElementById('inputRecursoId').value = recursoId;
        document.getElementById('availabilityForm').submit();
    }
</script>

{% if data %}
<!-- FullCalendar CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/es.js"></script>
<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('calendar');
    if (!el) {
      console.error('Elemento calendar no encontrado');
      return;
    }
    
    const fecha = el.getAttribute('data-fecha');
    const raw = el.getAttribute('data-reservas') || '[]';
    let reservas = [];
    try { 
      reservas = JSON.parse(raw); 
      console.log('Reservas cargadas:', reservas);
    } catch(e) { 
      console.error('Error parseando reservas:', e);
      reservas = []; 
    }
    
    const confDurMin = parseInt(el.getAttribute('data-dur-min') || '15', 10);
    const confDurMax = parseInt(el.getAttribute('data-dur-max') || '120', 10);
    const horaIni = (el.getAttribute('data-hora-ini') || '07:00') + ':00';
    const horaFin = (el.getAttribute('data-hora-fin') || '22:00') + ':00';
    
    // Calcular slotDuration basado en confDurMin
    // Si confDurMin es 15, 30, 60, etc., usarlo como slotDuration.
    // Si es un valor extraño, usar 15 por defecto o tratar de aproximar.
    let slotDuration = '00:15:00';
    if (confDurMin > 0) {
        const hours = Math.floor(confDurMin / 60);
        const minutes = confDurMin % 60;
        slotDuration = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
    }

    // Transformar reservas a eventos ocupados
    const events = reservas.map(r => ({
      title: `${r.usuario}`,
      start: `${fecha}T${String(r.hora_inicio).padStart(5,'0')}`,
      end: `${fecha}T${String(r.hora_fin).padStart(5,'0')}`,
      classNames: ['fc-event-occupied'],
      editable: false,
      overlap: false
    }));
    
    console.log('Eventos para FullCalendar:', events);
    const calendar = new FullCalendar.Calendar(el, {
      locale: 'es',
      initialView: 'timeGridDay',
      height: 650,
      allDaySlot: false,
      slotDuration: slotDuration,
      slotMinTime: horaIni,
      slotMaxTime: horaFin,
      expandRows: true,
      selectable: true,
      selectMirror: true,
      initialDate: fecha,
      validRange: {
        start: fecha,
        end: fecha
      },
      headerToolbar: { left: '', center: 'title', right: '' },
      titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
      businessHours: {
        daysOfWeek: [1,2,3,4,5,6], // Lunes-Sábado
        startTime: horaIni.substring(0,5),
        endTime: horaFin.substring(0,5)
      },
      eventContent: function(arg) {
        let content = document.createElement('div');
        content.className = 'fc-custom-content';
        content.innerHTML = '<i class="fas fa-lock"></i> ' + arg.event.title;
        return { domNodes: [content] }
      },
      events: events,
      selectConstraint: 'businessHours',
      selectOverlap: false,
      select: function(info){
        const hi = info.startStr.substring(11,16);
        const hf = info.endStr.substring(11,16);
        const selDate = new Date(info.startStr);
        if (selDate.getDay() === 0) { // Domingo
          Swal.fire({
            icon: 'warning',
            title: 'Fecha no disponible',
            text: 'No se permiten reservas en domingo.',
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        // Duración cliente (en minutos)
        const startMs = info.start.getTime();
        const endMs = info.end.getTime();
        const durSel = (endMs - startMs) / 60000;
        if (durSel < confDurMin || durSel > confDurMax) {
          Swal.fire({
            icon: 'error',
            title: 'Duración Inválida',
            text: `La reserva debe durar entre ${confDurMin} y ${confDurMax} minutos.`,
            confirmButtonColor: '#3085d6'
          });
          return;
        }
        document.getElementById('horaInicio').value = hi;
        document.getElementById('horaFin').value = hf;
        const infoBox = document.getElementById('seleccionInfo');
  infoBox.textContent = `Seleccionado ${hi} a ${hf} (Duración: ${durSel} min)`;
        document.getElementById('crearForm').classList.remove('d-none');
      }
    });
    calendar.render();
    
    // Restaurar selección si hay datos previos (error en validación)
    const savedHi = document.getElementById('horaInicio').value;
    const savedHf = document.getElementById('horaFin').value;
    if (savedHi && savedHf) {
      // Formato ISO para FullCalendar
      const start = `${fecha}T${savedHi}:00`;
      const end = `${fecha}T${savedHf}:00`;
      // Seleccionar visualmente (esto dispara el evento select)
      calendar.select(start, end);
    }

    console.log('✓ Calendario renderizado');
  });
})();
</script>

<!-- Sistema de búsqueda de acompañantes -->
<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
  const usuariosActivos = {{ usuarios_activos|tojson }};
  const usuarioActualId = {{ session.user_id }};
  const acompanantesSeleccionados = new Set();
  
  const inputBuscar = document.getElementById('buscarUsuario');
  const btnBuscar = document.getElementById('btnBuscarUsuario');
  const resultadosDiv = document.getElementById('resultadosBusqueda');
  const listaAcompanantesDiv = document.getElementById('listaAcompanantes');
  
  function buscarUsuarios() {
    const termino = inputBuscar.value.trim().toLowerCase();
    if (termino.length < 2) {
      resultadosDiv.style.display = 'none';
      return;
    }
    
    // Filtrar usuarios (excluir admin, excluir usuario actual, excluir ya seleccionados)
    const resultados = usuariosActivos.filter(u => 
      u.id !== usuarioActualId && 
      !acompanantesSeleccionados.has(u.id) &&
      (u.nombre.toLowerCase().includes(termino) || u.apellido.toLowerCase().includes(termino) || u.correo.toLowerCase().includes(termino)) &&
      u.correo.includes('@pucesa.edu.ec') // Solo usuarios institucionales
    );
    
    if (resultados.length === 0) {
      resultadosDiv.innerHTML = '<div class="list-group-item text-muted">No se encontraron usuarios</div>';
      resultadosDiv.style.display = 'block';
      return;
    }
    
    resultadosDiv.innerHTML = '';
    resultados.forEach(usuario => {
      const item = document.createElement('a');
      item.href = '#';
      item.className = 'list-group-item list-group-item-action';
      item.innerHTML = `<strong>${usuario.nombre} ${usuario.apellido}</strong><br><small class="text-muted">${usuario.correo}</small>`;
      item.onclick = (e) => {
        e.preventDefault();
        agregarAcompanante(usuario);
      };
      resultadosDiv.appendChild(item);
    });
    
    resultadosDiv.style.display = 'block';
  }
  
  function agregarAcompanante(usuario) {
    if (acompanantesSeleccionados.has(usuario.id)) return;
    
    acompanantesSeleccionados.add(usuario.id);
    
    // Crear badge con el acompañante
    const badge = document.createElement('span');
    badge.className = 'badge badge-info mr-2 mb-2';
    badge.style.fontSize = '0.9rem';
    badge.style.padding = '0.4rem 0.6rem';
    badge.innerHTML = `
      ${usuario.nombre}
      <button type="button" class="btn btn-link btn-sm text-white p-0 ml-1" style="text-decoration: none;" onclick="quitarAcompanante(${usuario.id}, this)">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    // Agregar hidden input para enviar en el form
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'acompanantes';
    input.value = usuario.id;
    input.id = 'acomp-input-' + usuario.id;
    
    listaAcompanantesDiv.appendChild(badge);
    document.getElementById('crearForm').appendChild(input);
    
    // Limpiar búsqueda
    inputBuscar.value = '';
    resultadosDiv.style.display = 'none';
  }
  
  window.quitarAcompanante = function(userId, btn) {
    acompanantesSeleccionados.delete(userId);
    btn.closest('.badge').remove();
    const input = document.getElementById('acomp-input-' + userId);
    if (input) input.remove();
  };
  
  // Event listeners
  btnBuscar.addEventListener('click', buscarUsuarios);
  inputBuscar.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      buscarUsuarios();
    }
  });
  
  // Cerrar resultados al hacer click fuera
  document.addEventListener('click', function(e) {
    if (!inputBuscar.contains(e.target) && !btnBuscar.contains(e.target) && !resultadosDiv.contains(e.target)) {
      resultadosDiv.style.display = 'none';
    }
  });
  
  console.log('✓ Sistema de acompañantes inicializado');
});
})();
</script>
{% endif %}
{% endblock %}
