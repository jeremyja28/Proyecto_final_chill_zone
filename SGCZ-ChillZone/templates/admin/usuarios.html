{% extends 'layouts/adminlte_base.html' %}
{% set title = 'Gestión de Usuarios' %}
{% block page_header %}
<div class="row mb-2">
  <div class="col-sm-6"><h1 class="m-0">Gestión de Usuarios</h1></div>
  <div class="col-sm-6"><ol class="breadcrumb float-sm-right"><li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li><li class="breadcrumb-item active">Usuarios</li></ol></div>
</div>
{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card card-success mb-3">
      <div class="card-header"><h3 class="card-title"><i class="fas fa-user-plus mr-2"></i>Registrar nuevo usuario</h3></div>
      <form method="post" action="{{ url_for('admin.crear_usuario') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="card-body">
          <div class="form-row">
            <div class="form-group col-md-2">
              <label>Nombre</label>
              <input class="form-control" name="nombre" value="{{ form_prefill.nombre if form_prefill }}" required />
            </div>
            <div class="form-group col-md-2">
              <label>Apellido</label>
              <input class="form-control" name="apellido" value="{{ form_prefill.apellido if form_prefill }}" required />
            </div>
            <div class="form-group col-md-3">
              <label>Correo electrónico</label>
              <input type="email" class="form-control" name="correo" value="{{ form_prefill.correo if form_prefill }}" required />
            </div>
            <div class="form-group col-md-2">
              <label>Rol</label>
              <select name="rol" class="form-control">
                <option value="USUARIO" {% if form_prefill and form_prefill.rol=='USUARIO' %}selected{% endif %}>USUARIO</option>
                <option value="ADMIN" {% if form_prefill and form_prefill.rol=='ADMIN' %}selected{% endif %}>ADMIN</option>
              </select>
            </div>
            <div class="form-group col-md-3">
              <label>Contraseña</label>
              <input type="password" class="form-control" name="password" placeholder="Mínimo 8 caracteres" required />
            </div>
          </div>
        </div>
        <div class="card-footer text-right">
          <button type="submit" class="btn btn-success"><i class="fas fa-user-plus mr-1"></i> Registrar usuario</button>
        </div>
      </form>
    </div>

    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users mr-2"></i>Listado de usuarios</h3>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
            {% for u in usuarios %}
              <tr>
                <td>{{ u.nombre }}</td>
                <td>{{ u.apellido }}</td>
                <td>{{ u.correo }}</td>
                <td>
                  <form method="post" action="{{ url_for('admin.cambiar_rol', user_id=u.id) }}" class="form-inline" onsubmit="confirmAction(event, this, '¿Actualizar rol?', 'El rol del usuario será modificado.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <select name="rol" class="form-control form-control-sm mr-2">
                      {% for r in ['USUARIO','ADMIN'] %}
                        <option value="{{ r }}" {% if u.rol==r %}selected{% endif %}>{{ r }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary" title="Actualizar rol"><i class="fas fa-sync"></i></button>
                  </form>
                </td>
                <td>
                  <form method="post" action="{{ url_for('admin.bloquear', user_id=u.id) }}" class="d-inline" onsubmit="confirmAction(event, this, '¿{{ 'Activar' if u.estado=='BLOQUEADO' else 'Inactivar' }} usuario?', 'El estado del usuario cambiará.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    {% if u.estado=='BLOQUEADO' %}
                      <span class="badge badge-secondary mr-2">INACTIVO</span>
                      <button class="btn btn-sm btn-outline-success" title="Activar"><i class="fas fa-check"></i> Activar</button>
                    {% else %}
                      <span class="badge badge-success mr-2">ACTIVO</span>
                      <button class="btn btn-sm btn-outline-danger" title="Inactivar"><i class="fas fa-ban"></i> Inactivar</button>
                    {% endif %}
                  </form>
                  <form method="post" action="{{ url_for('admin.reset_password', user_id=u.id) }}" class="d-inline ml-1" onsubmit="confirmAction(event, this, '¿Resetear contraseña?', 'Se generará una nueva contraseña aleatoria.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button class="btn btn-sm btn-outline-warning" title="Resetear Contraseña"><i class="fas fa-key"></i></button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="4" class="text-center text-muted py-4">No hay usuarios registrados</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
