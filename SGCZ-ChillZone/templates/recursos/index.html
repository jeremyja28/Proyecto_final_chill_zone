{% extends 'layouts/adminlte_base.html' %}
{% set title = 'Recursos' %}
{% block page_header %}
<div class="row mb-2">
  <div class="col-sm-6"><h1 class="m-0">Recursos</h1></div>
  <div class="col-sm-6"><ol class="breadcrumb float-sm-right"><li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li><li class="breadcrumb-item active">Recursos</li></ol></div>
  {% if current_user.rol == 'ADMIN' %}
  <div class="col-12 mt-2">
    <button class="btn btn-success" data-toggle="modal" data-target="#modalCrear"><i class="fas fa-plus mr-1"></i> Nuevo recurso</button>
    <button class="btn btn-info ml-2" data-toggle="modal" data-target="#modalCrearZona"><i class="fas fa-map-marker-alt mr-1"></i> Crear Zona</button>
  </div>
  {% endif %}
</div>
{% endblock %}
{% block content %}
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover mb-0">
        <thead class="thead-light"><tr><th>ID</th><th>Imagen</th><th>Nombre</th><th>Zona</th><th>Tipo</th><th>Ubicación</th><th>Estado</th>{% if current_user.rol=='ADMIN' %}<th>Acciones</th>{% endif %}</tr></thead>
        <tbody>
        {% for r in recursos %}
          <tr>
            <td>{{ r.id }}</td>
            <td>
              {% if r.imagen_url %}
                <img src="{{ r.imagen_url }}" alt="{{ r.nombre }}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;" onclick="showImage('{{ r.imagen_url }}')">
              {% else %}
                <span class="text-muted"><i class="fas fa-image fa-2x"></i></span>
              {% endif %}
            </td>
            <td>{{ r.nombre }}</td>
            <td>{{ r.zona_nombre }}</td>
            <td>{{ r.tipo }}</td>
            <td>{{ r.ubicacion }}</td>
            <td>
              {% if current_user.rol == 'ADMIN' %}
              <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle="modal" data-target="#modalEstado" data-id="{{ r.id }}" data-estado="{{ r.estado }}">{{ r.estado.replace('_', ' ').title() }}</button>
              {% else %}
                {{ r.estado.replace('_', ' ').title() }}
              {% endif %}
            </td>
            {% if current_user.rol == 'ADMIN' %}
            <td>
              <button type="button" class="btn btn-sm btn-outline-primary" data-toggle="modal" data-target="#modalEditar" data-id="{{ r.id }}" data-nombre="{{ r.nombre }}" data-tipo="{{ r.tipo }}" data-ubicacion="{{ r.ubicacion }}" data-zona-id="{{ r.zona_id }}"><i class="fas fa-edit"></i></button>
              <form method="post" action="{{ url_for('recursos.eliminar', recurso_id=r.id) }}" class="d-inline ml-1" onsubmit="return confirmAction('¿Eliminar recurso?', 'El recurso será eliminado lógicamente.')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
              </form>
            </td>
            {% endif %}
          </tr>
        {% else %}
          <tr><td colspan="6" class="text-center text-muted">No hay recursos</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if current_user.rol == 'ADMIN' %}
<!-- Modal Crear -->
<div class="modal fade" id="modalCrear" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="post" action="{{ url_for('recursos.crear') }}" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="modal-header"><h5 class="modal-title">Nuevo recurso</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body">
        <div class="form-group"><label>Nombre</label><input class="form-control" name="nombre" required></div>
        <div class="form-group">
          <label>Zona</label>
          <select class="form-control" name="zona_id" required>
            <option value="">Seleccione una zona</option>
            {% for z in zonas %}
            <option value="{{ z.id }}">{{ z.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group"><label>Tipo</label><input class="form-control" name="tipo"></div>
        <div class="form-group"><label>Ubicación (Detalle)</label><input class="form-control" name="ubicacion"></div>
        <div class="form-group"><label>Imagen del Recurso</label><input type="file" class="form-control-file" name="imagen" accept="image/*"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button class="btn btn-primary">Guardar</button></div>
    </form>
  </div></div>
</div>

<!-- Modal Crear Zona -->
<div class="modal fade" id="modalCrearZona" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="post" action="{{ url_for('zonas.crear') }}" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="modal-header"><h5 class="modal-title">Nueva Zona</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body">
        <div class="form-group"><label>Nombre</label><input class="form-control" name="nombre" required></div>
        <div class="form-group"><label>Descripción</label><textarea class="form-control" name="descripcion"></textarea></div>
        <div class="form-group"><label>Imagen de la Zona</label><input type="file" class="form-control-file" name="imagen" accept="image/*"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button class="btn btn-primary">Guardar</button></div>
    </form>
  </div></div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="post" id="formEditar" action="#" enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <input type="hidden" name="recurso_id" id="edit_id">
      <div class="modal-header"><h5 class="modal-title">Editar recurso</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body">
        <div class="form-group"><label>Nombre</label><input class="form-control" name="nombre" id="edit_nombre" required></div>
        <div class="form-group">
          <label>Zona</label>
          <select class="form-control" name="zona_id" id="edit_zona_id" required>
            <option value="">Seleccione una zona</option>
            {% for z in zonas %}
            <option value="{{ z.id }}">{{ z.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group"><label>Tipo</label><input class="form-control" name="tipo" id="edit_tipo"></div>
        <div class="form-group"><label>Ubicación (Detalle)</label><input class="form-control" name="ubicacion" id="edit_ubicacion"></div>
        <div class="form-group"><label>Cambiar Imagen</label><input type="file" class="form-control-file" name="imagen" accept="image/*"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button class="btn btn-primary">Guardar Cambios</button></div>
    </form>
  </div></div>
</div>

<!-- Modal Estado con Mantenimiento -->
<div class="modal fade" id="modalEstado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="post" id="formEstado" action="#">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="modal-header"><h5 class="modal-title">Cambiar estado</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
      <div class="modal-body">
        <div class="form-group">
          <label>Estado</label>
          <select class="form-control" name="estado" id="estadoSelect">
            <option value="DISPONIBLE">Disponible</option>
            <option value="EN_MANTENIMIENTO">En mantenimiento</option>
            <option value="FUERA_DE_SERVICIO">Fuera de servicio</option>
          </select>
        </div>
        <div id="mantenimientoFields" style="display:none;">
          <div class="form-group"><label>Inicio</label><input type="datetime-local" class="form-control" name="mant_inicio" id="mantInicio" /></div>
          <div class="form-group"><label>Fin</label><input type="datetime-local" class="form-control" name="mant_fin" id="mantFin" /></div>
          <small class="text-muted">Solo se cancelarán reservas que solapen con este periodo.</small>
        </div>
        <div id="fueraServicioWarning" style="display:none;" class="alert alert-danger mt-3">
          <i class="fas fa-exclamation-triangle"></i> <strong>¡Atención!</strong><br>
          Al marcar como "Fuera de servicio", se cancelarán <strong>TODAS</strong> las reservas futuras de este recurso indefinidamente.
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button><button class="btn btn-primary">Guardar</button></div>
    </form>
  </div></div>
</div>
{% endif %}

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-transparent border-0 shadow-none">
      <div class="modal-body text-center p-0">
        <button type="button" class="close text-white position-absolute" style="right: 10px; top: -30px; z-index: 1051; opacity: 1;" data-dismiss="modal">&times;</button>
        <img src="" id="previewImage" class="img-fluid rounded shadow-lg" style="max-height: 85vh;">
      </div>
    </div>
  </div>
</div>

<script>
  function showImage(url) {
    document.getElementById('previewImage').src = url;
    $('#imageModal').modal('show');
  }
</script>
{% endblock %}

{% block extra_js %}
{% if current_user.rol == 'ADMIN' %}
<script>
  $(document).ready(function() {
    $('#modalEditar').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var modal = $(this);
      modal.find('#edit_id').val(button.data('id'));
      modal.find('#edit_nombre').val(button.data('nombre'));
      modal.find('#edit_tipo').val(button.data('tipo'));
      modal.find('#edit_ubicacion').val(button.data('ubicacion'));
      modal.find('#edit_zona_id').val(button.data('zona-id'));
    });

    $('#modalEstado').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var id = button.data('id');
      var estado = button.data('estado');
      var modal = $(this);
      modal.find('#estadoSelect').val(estado);
      var baseUrl = "{{ url_for('recursos.estado', recurso_id=0) }}";
      modal.find('#formEstado').attr('action', baseUrl.replace(/0$/, id));
      toggleMantenimiento();
    });

    $('#estadoSelect').on('change', function() {
      toggleMantenimiento();
    });

    function toggleMantenimiento() {
      var estado = $('#estadoSelect').val();
      $('#mantenimientoFields').hide();
      $('#fueraServicioWarning').hide();

      if (estado === 'EN_MANTENIMIENTO') {
        $('#mantenimientoFields').show();
        // Set defaults: now to now+24h if empty
        if (!$('#mantInicio').val()) {
            var now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            $('#mantInicio').val(now.toISOString().slice(0,16));
        }
        if (!$('#mantFin').val()) {
            var now = new Date();
            var later = new Date(now.getTime() + 24*60*60*1000);
            later.setMinutes(later.getMinutes() - later.getTimezoneOffset());
            $('#mantFin').val(later.toISOString().slice(0,16));
        }
      } else if (estado === 'FUERA_DE_SERVICIO') {
        $('#fueraServicioWarning').show();
      }
    }
  });
</script>
{% endif %}
{% endblock %}
