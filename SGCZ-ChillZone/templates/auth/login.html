<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login - PUCESA Reservation</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
        --pucesa-blue: #003366;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: 'Poppins', sans-serif; 
        min-height: 100vh; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: linear-gradient(rgba(0, 51, 102, 0.8), rgba(0, 51, 102, 0.8)), url("{{ url_for('static', filename='img/login_pucesa.png') }}") center/cover no-repeat fixed;
    }
    .login-container { width: 100%; max-width: 440px; padding: 20px; animation: fadeInUp 0.6s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .login-card { 
        background: rgba(255,255,255,0.98); 
        border-top: 5px solid var(--pucesa-blue);
        border-radius: 10px; 
        padding: 40px 35px; 
        box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
    }
    .logo-section { text-align: center; margin-bottom: 30px; }
    .logo-section img { height: 80px; margin-bottom: 15px; transition: transform 0.3s; }
    .logo-section img:hover { transform: scale(1.05); }
    .logo-section h1 { font-size: 24px; font-weight: 700; color: var(--pucesa-blue); margin-bottom: 5px; text-transform: uppercase; }
    .logo-section p { font-size: 14px; color: #6c757d; font-weight: 400; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 14px; font-weight: 600; color: var(--pucesa-blue); margin-bottom: 8px; }
    .input-wrapper { position: relative; }
    .input-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--pucesa-blue); font-size: 16px; }
    .form-control { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 15px; font-weight: 400; color: #495057; transition: all 0.3s ease; background: #f8f9fa; }
    .form-control:focus { outline: none; border-color: var(--pucesa-blue); background: #fff; box-shadow: 0 0 0 4px rgba(0, 51, 102, 0.2); }
    .form-control::placeholder { color: #adb5bd; }
    .forgot-password { text-align: right; margin-bottom: 20px; }
    .forgot-password a { font-size: 13px; color: var(--pucesa-blue); text-decoration: none; font-weight: 500; transition: color 0.3s ease; cursor: pointer; }
    .forgot-password a:hover { color: #0056b3; text-decoration: underline; }
    .btn-login { 
        width: 100%; 
        padding: 14px; 
        background: var(--pucesa-blue); 
        color: #fff; 
        border: none; 
        border-radius: 5px; 
        font-size: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        box-shadow: 0 4px 15px rgba(0, 51, 102, 0.3); 
        text-transform: uppercase;
    }
    .btn-login:hover { 
        background: #002244; 
        transform: translateY(-2px); 
        box-shadow: 0 6px 20px rgba(0, 51, 102, 0.4); 
    }
    .btn-login:active { transform: translateY(0); }
    .alert { padding: 12px 16px; border-radius: 5px; margin-bottom: 20px; font-size: 14px; font-weight: 500; }
    .alert-success { background: #d1f2eb; color: #0f5132; border-left: 4px solid #20c997; }
    .alert-danger { background: #f8d7da; color: #842029; border-left: 4px solid #dc3545; }
    .alert-info { background: #cfe2ff; color: #084298; border-left: 4px solid #0d6efd; }
    .footer-text { text-align: center; margin-top: 25px; font-size: 13px; color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    
    @media (max-width: 576px) { .login-container { padding: 15px; } .login-card { padding: 30px 25px; } .logo-section h1 { font-size: 20px; } .logo-section img { height: 60px; } .form-control { padding: 12px 12px 12px 42px; font-size: 14px; } .btn-login { padding: 12px; font-size: 15px; } }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="logo-section">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='img/logo_chill_zone.png') }}" alt="PUCESA Logo" onerror="this.style.display='none'">
        </a>
        <h1>PUCESA Reservation</h1>
        <p>Sistema de Gestión Recreativa</p>
      </div>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      <form method="post" novalidate>
        <div style="display:none;">{{ form.csrf_token }}</div>
        <div class="form-group">
          <label for="email">Correo Institucional</label>
          <div class="input-wrapper">
            <i class="fas fa-user"></i>
            {{ form.email(class='form-control', id='email', placeholder='ejemplo@pucesa.edu.ec', autocomplete='email', autofocus=true) }}
          </div>
        </div>
        <div class="form-group">
          <label for="password">Contraseña</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            {{ form.password(class='form-control', id='password', placeholder='Ingresa tu contraseña', autocomplete='current-password') }}
            <i class="fas fa-eye" id="togglePassword" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--pucesa-blue); left: auto;" onclick="toggleLoginPassword()"></i>
          </div>
        </div>
        <div class="forgot-password">
          <a href="#" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">¿Olvidaste tu contraseña?</a>
        </div>
        <button type="submit" class="btn-login">
          <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
        </button>
      </form>
    </div>
    <div class="footer-text"><strong>PUCESA</strong> &copy; 2025 | Todos los derechos reservados</div>
  </div>

  <!-- Forgot Password Modal -->
  <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background-color: var(--pucesa-blue); color: white;">
          <h5 class="modal-title" id="forgotPasswordModalLabel">Recuperar Contraseña</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="step1">
            <p>Ingresa tu correo institucional para recibir un código de verificación.</p>
            <div class="mb-3">
              <label for="recoverEmail" class="form-label">Correo Institucional</label>
              <input type="email" class="form-control" id="recoverEmail" placeholder="ejemplo@pucesa.edu.ec">
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary" style="background-color: var(--pucesa-blue); border: none;" onclick="sendCode()">Enviar Código</button>
            </div>
          </div>

          <div id="step2" style="display: none;">
            <p>Se te ha enviado un código al correo, ingrésalo.</p>
            <div class="mb-3">
              <label for="recoverCode" class="form-label">Código de Verificación</label>
              <input type="text" class="form-control" id="recoverCode" placeholder="Código">
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary" style="background-color: var(--pucesa-blue); border: none;" onclick="verifyCode()">Verificar</button>
            </div>
          </div>

          <div id="step3" style="display: none;">
            <p>Ha ingresado el código correctamente, ingrese su nueva contraseña.</p>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nueva Contraseña</label>
              <input type="password" class="form-control" id="newPassword" placeholder="Nueva contraseña">
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary" style="background-color: var(--pucesa-blue); border: none;" onclick="resetPassword()">Cambiar Contraseña</button>
            </div>
          </div>
          
          <div id="recoverMessage" class="mt-3 text-center"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function toggleLoginPassword() {
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('togglePassword');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
      }
    }

    const csrfToken = "{{ form.csrf_token.current_token }}";

    function sendCode() {
        const email = document.getElementById('recoverEmail').value;
        const msgDiv = document.getElementById('recoverMessage');
        
        if(!email) {
            msgDiv.innerHTML = '<span class="text-danger">Ingresa un correo.</span>';
            return;
        }

        fetch("{{ url_for('auth.check_email_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                msgDiv.innerHTML = '';
            } else {
                msgDiv.innerHTML = '<span class="text-danger">' + data.message + '</span>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            msgDiv.innerHTML = '<span class="text-danger">Error al procesar solicitud.</span>';
        });
    }

    function verifyCode() {
        const code = document.getElementById('recoverCode').value;
        const msgDiv = document.getElementById('recoverMessage');

        if(code === '270320') {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'block';
            msgDiv.innerHTML = '';
        } else {
            msgDiv.innerHTML = '<span class="text-danger">Código incorrecto.</span>';
        }
    }

    function resetPassword() {
        const email = document.getElementById('recoverEmail').value;
        const code = document.getElementById('recoverCode').value;
        const password = document.getElementById('newPassword').value;
        const msgDiv = document.getElementById('recoverMessage');

        if(!password || password.length < 6) {
            msgDiv.innerHTML = '<span class="text-danger">La contraseña debe tener al menos 6 caracteres.</span>';
            return;
        }

        fetch("{{ url_for('auth.reset_password_api') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email, code: code, password: password})
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                msgDiv.innerHTML = '<span class="text-success">Contraseña actualizada correctamente. Redirigiendo...</span>';
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                msgDiv.innerHTML = '<span class="text-danger">' + data.message + '</span>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            msgDiv.innerHTML = '<span class="text-danger">Error al procesar solicitud.</span>';
        });
    }
  </script>
</body>
</html>