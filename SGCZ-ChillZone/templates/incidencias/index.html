{% extends 'layouts/adminlte_base.html' %}
{% set title = 'Incidencias' %}
{% block page_header %}
<div class="row mb-2">
  <div class="col-sm-6"><h1 class="m-0">Incidencias</h1></div>
  <div class="col-sm-6">
    <ol class="breadcrumb float-sm-right"><li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li><li class="breadcrumb-item active">Incidencias</li></ol>
  </div>
</div>
{% endblock %}
{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card card-outline card-secondary">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0"><i class="fas fa-list mr-1"></i> Historial</h3>
        <span class="badge badge-info">{{ incidencias|length }} reporte(s)</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="thead-light">
              <tr>
                <th>Fecha</th>
                {% if session.get('rol')=='ADMIN' %}
                <th>Usuario</th>
                {% endif %}
                <th>Recurso</th>
                <th>Reserva</th>
                <th>Descripción</th>
                {% if session.get('rol')=='ADMIN' %}
                <th>Responsable</th>
                {% endif %}
                <th>Evidencia</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
            {% for i in incidencias %}
              <tr>
                <td class="date-cell">{{ i.creado_en }}</td>
                {% if session.get('rol')=='ADMIN' %}
                <td>
                  <div class="user-block">
                    <span class="username text-primary" style="font-size: 0.9rem;">{{ i.usuario_nombre }} {{ i.usuario_apellido }}</span>
                    <span class="description" style="margin-left: 0;">{{ i.usuario_correo }}</span>
                  </div>
                </td>
                {% endif %}
                <td>{{ i.recurso_nombre or i.recurso_id }}</td>
                <td>
                  {% if i.reserva_id %}
                    <small>{{ i.reserva_fecha }}<br>{{ i.reserva_hora_inicio }}</small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="small">{{ i.descripcion }}</td>
                {% if session.get('rol')=='ADMIN' %}
                <td>
                  {% if i.responsables %}
                    {% for resp in i.responsables %}
                      <span class="badge badge-warning mr-1" style="font-size: 0.85rem;">
                        <i class="fas fa-exclamation-circle mr-1"></i>{{ resp.nombre }}
                      </span>
                    {% endfor %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                {% endif %}
                <td>
                  {% if i.evidencia_url %}
                    {% if i.evidencia_url.endswith(('.pdf', '.PDF')) %}
                      <a href="{{ i.evidencia_url }}" target="_blank" class="btn btn-xs btn-outline-danger" title="Ver PDF"><i class="fas fa-file-pdf"></i></a>
                    {% elif i.evidencia_url.startswith('/static/') or i.evidencia_url.endswith(('.jpg', '.jpeg', '.png', '.gif')) %}
                      <button type="button" class="btn btn-xs btn-outline-info" title="Ver imagen" onclick="showImage('{{ i.evidencia_url }}')"><i class="fas fa-image"></i></button>
                    {% else %}
                      <a href="{{ i.evidencia_url }}" target="_blank" class="btn btn-xs btn-outline-secondary" title="Ver enlace"><i class="fas fa-link"></i></a>
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  <span class="badge badge-{{ 'warning' if i.estado=='PENDIENTE' else 'success' }}">{{ 'Pendiente' if i.estado=='PENDIENTE' else 'Arreglada' }}</span>
                  {% if session.get('rol')=='ADMIN' %}
                  <form method="post" action="{{ url_for('incidencias.cambiar_estado', incidencia_id=i.id) }}" class="d-inline" onsubmit="return confirmAction('¿Cambiar estado?', 'El estado de la incidencia se actualizará.')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button class="btn btn-xs btn-outline-secondary" title="Cambiar estado">↺</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
            {% else %}
              <tr><td colspan="{{ '7' if session.get('rol')=='ADMIN' else '6' }}" class="text-center text-muted">Sin incidencias</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Evidencia</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid" alt="Evidencia">
      </div>
    </div>
  </div>
</div>

<script>
  function showImage(url) {
    document.getElementById('modalImage').src = url;
    $('#imageModal').modal('show');
  }
</script>
{% endblock %}